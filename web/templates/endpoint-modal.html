{{/* Endpoint Modal Component */}}
<div class="modal fade" id="endpointModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="endpointModalTitle">添加端点</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="endpointForm">
                    <input type="hidden" id="endpoint-id" />
                    
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-3" id="endpointModalTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-tab-pane" 
                                    type="button" role="tab" aria-controls="basic-tab-pane" aria-selected="true">
                                <i class="fas fa-cog"></i> <span data-t="basic_configuration">基本配置</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-tab-pane" 
                                    type="button" role="tab" aria-controls="advanced-tab-pane" aria-selected="false">
                                <i class="fas fa-sliders-h"></i> <span data-t="advanced_configuration1">高级参数1</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="advanced2-tab" data-bs-toggle="tab" data-bs-target="#advanced2-tab-pane" 
                                    type="button" role="tab" aria-controls="advanced2-tab-pane" aria-selected="false">
                                <i class="fas fa-cogs"></i> <span data-t="advanced_configuration2">高级参数2</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="endpointModalTabContent">
                        <!-- Basic Configuration Tab -->
                        <div class="tab-pane fade show active" id="basic-tab-pane" role="tabpanel" aria-labelledby="basic-tab">
                            <!-- 第一行：名称、默认模型和启用状态 -->
                            <div class="row mb-3">
                                <div class="col-4">
                                    <label for="endpoint-name" class="form-label">
                                        <i class="fas fa-tag form-label-icon"></i><span data-t="name">名称</span> <span class="text-danger">*</span>
                                        <a href="https://ucn0s6hcz1w1.feishu.cn/sheets/RNPHswfIThqQ1itf1m4cb0mKnrc" target="_blank" class="ms-2 text-primary text-sm">
                                            <span data-t="common_endpoint_provider_params">(常见端点提供商参数)</span>
                                        </a>
                                    </label>
                                    <input type="text" class="form-control" id="endpoint-name" required>
                                </div>
                                <div class="col-4">
                                    <label for="endpoint-default-model" class="form-label">
                                        <i class="fas fa-robot form-label-icon"></i><span data-t="default_model">默认模型</span>
                                        <i class="fas fa-question-circle text-muted ms-1" data-t-title="default_model_tooltip" title="可以快捷设置此端点支持的唯一模型名，例如 openai/gpt-5" data-bs-toggle="tooltip"></i>
                                    </label>
                                    <input type="text" class="form-control" id="endpoint-default-model" 
                                           data-t-placeholder="default_model_placeholder" placeholder="如: claude-3-5-haiku-20241022">
                                    <small class="form-text text-muted d-none-custom" id="default-model-hint">
                                        <span data-t="model_rewrite_incompatible_settings">Model Rewrite中有不兼容的设置</span>
                                    </small>
                                </div>
                                <div class="col-4 d-flex align-items-center">
                                    <div class="w-100 d-flex justify-content-end">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="endpoint-enabled" checked>
                                            <label class="form-check-label" for="endpoint-enabled" data-t="enable_this_endpoint">
                                                启用此端点
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 第二行：URL 和 Tags -->
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label for="endpoint-url" class="form-label">
                                        <i class="fas fa-link form-label-icon"></i><span data-t="url">URL</span> <span class="text-danger">*</span>
                                    </label>
                                    <input type="url" class="form-control" id="endpoint-url" required
                                           placeholder="https://api.example.com">
                                </div>
                                <div class="col-4">
                                    <label for="endpoint-tags" class="form-label">
                                        <i class="fas fa-tags form-label-icon"></i><span data-t="tags">标签</span>
                                    </label>
                                    <input type="text" class="form-control" id="endpoint-tags" 
                                           data-t-placeholder="comma_separated" placeholder="用逗号分隔">
                                    <small class="form-text text-muted" data-t="empty_for_universal_endpoint">留空为通用端点</small>
                                </div>
                            </div>

                            <!-- 第三行：端点类型和路径前缀 -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label for="endpoint-type" class="form-label">
                                        <i class="fas fa-cogs form-label-icon"></i><span data-t="endpoint_type">端点类型</span> <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="endpoint-type" required data-change="endpoint-type">
                                        <option value="anthropic">Anthropic (Claude)</option>
                                        <option value="openai">OpenAI Compatible</option>
                                    </select>
                                    <small class="form-text text-muted" data-t="select_api_compatible_type">选择端点的API兼容类型</small>
                                </div>
                                <div class="col-6 d-none-custom" id="path-prefix-group">
                                    <label for="endpoint-path-prefix" class="form-label">
                                        <i class="fas fa-route form-label-icon"></i><span data-t="path_prefix">路径前缀</span>
                                    </label>
                                    <input type="text" class="form-control" id="endpoint-path-prefix"
                                           placeholder="/v1/chat/completions (留空表示原生支持 /responses)">
                                    <small class="form-text text-muted" data-t="openai_compatible_api_path">OpenAI兼容端点的API路径，留空表示原生支持 /responses</small>
                                </div>
                            </div>

                            <!-- 第四行：认证方式和认证值 -->
                            <div class="row mb-3">
                                <div class="col-4">
                                    <label for="endpoint-auth-type" class="form-label">
                                        <i class="fas fa-key form-label-icon"></i><span data-t="authentication_method">认证方式</span> <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="endpoint-auth-type" required data-change="auth-type">
                                        <option value="api_key" data-t-option="api_key_option">API Key (x-api-key)</option>
                                        <option value="auth_token" selected data-t-option="auth_token_option">Auth Token (Authorization Bearer)</option>
                                        <option value="oauth" data-t-option="oauth_option">OAuth 2.0</option>
                                    </select>
                                </div>
                                <div class="col-8">
                                    <div id="auth-value-group">
                                        <label for="endpoint-auth-value" class="form-label">
                                            <i class="fas fa-shield-alt form-label-icon"></i><span data-t="authentication_value">认证值</span> <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="endpoint-auth-value" required
                                                   data-t-placeholder="enter_api_key_or_token" placeholder="输入您的 API Key 或 Token">
                                            <button class="btn btn-outline-secondary" type="button" id="toggle-auth-visibility" data-action="toggle-auth-visibility">
                                                <i class="fas fa-eye" id="auth-eye-icon"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- OAuth 配置区域 -->
                                    <div id="oauth-config-group" class="d-none-custom">
                                        <label class="form-label">
                                            <i class="fas fa-shield-alt form-label-icon"></i><span data-t="oauth_configuration">OAuth 配置</span> <span class="text-danger">*</span>
                                        </label>
                                        <div class="card">
                                            <div class="card-body p-3">
                                                <!-- Access Token -->
                                                <div class="mb-3">
                                                    <label for="oauth-access-token" class="form-label" data-t="access_token">访问令牌 <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="password" class="form-control" id="oauth-access-token" 
                                                               data-t-placeholder="access_token_placeholder" placeholder="访问令牌（如：sk-ant-oat01-... 或其他格式）">
                                                        <button class="btn btn-outline-secondary" type="button" data-action="toggle-oauth-visibility" data-token-id="oauth-access-token" data-eye-id="oauth-access-eye">
                                                            <i class="fas fa-eye" id="oauth-access-eye"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Refresh Token -->
                                                <div class="mb-3">
                                                    <label for="oauth-refresh-token" class="form-label" data-t="refresh_token">刷新令牌 <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="password" class="form-control" id="oauth-refresh-token" 
                                                               data-t-placeholder="refresh_token_placeholder" placeholder="刷新令牌（如：sk-ant-ort01-... 或其他格式）">
                                                        <button class="btn btn-outline-secondary" type="button" data-action="toggle-oauth-visibility" data-token-id="oauth-refresh-token" data-eye-id="oauth-refresh-eye">
                                                            <i class="fas fa-eye" id="oauth-refresh-eye"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Expires At -->
                                                <div class="row mb-3">
                                                    <div class="col-6">
                                                        <label for="oauth-expires-at" class="form-label"><span data-t="expires_timestamp_ms">过期时间戳 (毫秒)</span> <span class="text-danger">*</span></label>
                                                        <input type="number" class="form-control" id="oauth-expires-at" 
                                                               placeholder="1755272917673" min="0">
                                                        <small class="form-text text-muted" data-t="expires_at_help">填0可触发自动刷新获取正确的过期时间</small>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label" data-t="auto_refresh">自动刷新</label>
                                                        <div class="form-check mt-2">
                                                            <input class="form-check-input" type="checkbox" id="oauth-auto-refresh" checked>
                                                            <label class="form-check-label" for="oauth-auto-refresh" data-t="enable_auto_refresh">启用自动刷新</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Required Token URL -->
                                                <div class="mb-3">
                                                    <label for="oauth-token-url" class="form-label">Token URL <span class="text-danger">*</span></label>
                                                    <input type="url" class="form-control" id="oauth-token-url" 
                                                           placeholder="https://console.anthropic.com/v1/oauth/token">
                                                    <small class="form-text text-muted" data-t="oauth_token_refresh_endpoint_description">用于刷新OAuth token的端点地址</small>
                                                </div>
                                                
                                                <div class="row mb-3">
                                                    <div class="col-6">
                                                        <label for="oauth-client-id" class="form-label" data-t="client_id_optional">Client ID (可选)</label>
                                                        <input type="text" class="form-control" id="oauth-client-id" 
                                                               placeholder="9d1c250a-e61b-44d9-88ed-5944d1962f5e">
                                                    </div>
                                                    <div class="col-6">
                                                        <label for="oauth-scopes" class="form-label" data-t="scopes_optional">Scopes (可选)</label>
                                                        <input type="text" class="form-control" id="oauth-scopes" 
                                                               placeholder="user:inference,user:profile">
                                                    </div>
                                                </div>
                                                
                                                <div class="alert alert-info p-2 mb-0">
                                                    <small class="text-muted">
                                                        <strong data-t="description">说明：</strong><br>
                                                        <span data-t="oauth_provider_support">• 支持 Anthropic、OpenAI 及其他 OAuth 提供商</span><br>
                                                        <span data-t="api_request_sent_to_endpoint">• API请求将发送到端点URL地址</span><br>
                                                        <span data-t="token_url_description">• Token URL：指定OAuth token刷新的端点地址（必填）</span><br>
                                                        <span data-t="expires_timestamp_unix_ms">• 过期时间戳为毫秒级Unix时间戳</span><br>
                                                        <span data-t="auto_refresh_description">• 启用自动刷新时，系统会在token过期前自动刷新</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Configuration Tab -->
                        <div class="tab-pane fade" id="advanced-tab-pane" role="tabpanel" aria-labelledby="advanced-tab">
                            <!-- 代理配置区域 -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-shield-alt"></i> <span data-t="proxy_configuration">代理配置</span>
                                    </h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="proxy-enabled">
                                        <label class="form-check-label" for="proxy-enabled" data-t="enable_proxy">启用代理</label>
                                    </div>
                                </div>
                                
                                <div id="proxy-config" class="d-none-custom">
                                    <small class="form-text text-muted mb-3 d-block" data-t="configure_proxy_description">配置HTTP或SOCKS5代理以访问上游端点</small>
                                    
                                    <!-- 代理类型和地址 -->
                                    <div class="row mb-3">
                                        <div class="col-4">
                                            <label for="proxy-type" class="form-label" data-t="proxy_type">代理类型</label>
                                            <select class="form-select" id="proxy-type">
                                                <option value="http">HTTP</option>
                                                <option value="socks5">SOCKS5</option>
                                            </select>
                                        </div>
                                        <div class="col-8">
                                            <label for="proxy-address" class="form-label" data-t="proxy_address">代理地址</label>
                                            <input type="text" class="form-control" id="proxy-address" 
                                                   placeholder="127.0.0.1:1080">
                                            <small class="form-text text-muted" data-t="format_host_port">格式: 主机:端口</small>
                                        </div>
                                    </div>
                                    
                                    <!-- 代理认证 -->
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <label for="proxy-username" class="form-label" data-t="username_optional">用户名 (可选)</label>
                                            <input type="text" class="form-control" id="proxy-username" 
                                                   data-t-placeholder="proxy_auth_username" placeholder="代理认证用户名">
                                        </div>
                                        <div class="col-6">
                                            <label for="proxy-password" class="form-label" data-t="password_optional">密码 (可选)</label>
                                            <input type="password" class="form-control" id="proxy-password" 
                                                   data-t-placeholder="proxy_auth_password" placeholder="代理认证密码">
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info p-2">
                                        <small class="text-muted">
                                            <strong data-t="description">说明：</strong><br>
                                            <span data-t="proxy_no_auth_description">• 留空用户名和密码表示无需认证</span><br>
                                            <span data-t="http_proxy_connect_description">• HTTP代理支持 CONNECT 方法用于HTTPS</span><br>
                                            <span data-t="socks5_proxy_tcp_description">• SOCKS5代理支持TCP连接代理</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- 模型重写配置区域 -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-exchange-alt"></i> <span data-t="model_rewrite_configuration">模型重写配置</span>
                                    </h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="model-rewrite-enabled">
                                        <label class="form-check-label" for="model-rewrite-enabled" data-t="enable_model_rewrite">启用模型重写</label>
                                    </div>
                                </div>
                                
                                <div id="model-rewrite-rules" class="d-none-custom">
                                    <small class="form-text text-muted mb-3 d-block" data-t="configure_rewrite_rules_description">配置规则将匹配的Claude模型重写为其他模型</small>
                                    
                                    <div id="rewrite-rules-list">
                                        <!-- 动态生成的规则列表 -->
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-3" data-action="add-rewrite-rule">
                                        <i class="fas fa-plus"></i> <span data-t="add_rule">添加规则</span>
                                    </button>
                                    
                                    <div class="alert alert-info p-2">
                                        <small class="text-muted">
                                            <strong data-t="preset_model_patterns">预设模型模式：</strong><br>
                                            <span data-t="haiku_series_pattern">• Haiku系列: claude-*haiku*</span><br>
                                            <span data-t="sonnet_series_pattern">• Sonnet系列: claude-*sonnet*</span><br>
                                            <span data-t="opus_series_pattern">• Opus系列: claude-*opus*</span><br>
                                            <span data-t="all_claude_pattern">• 所有Claude: claude-*</span><br>
                                            <span data-t="gpt5_pattern">• GPT-5: gpt-5</span><br>
                                            <span data-t="gpt5_codex_pattern">• GPT-5 Codex: gpt-5-codex</span><br>
                                            <span data-t="all_gpt_pattern">• 所有GPT: gpt-*</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Max Tokens 字段名配置区域 -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-cogs"></i> <span data-t="max_tokens_field_configuration">Max Tokens 字段名配置</span>
                                    </h6>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <label for="max-tokens-field-name" class="form-label" data-t="max_tokens_field_name">Max Tokens 字段名</label>
                                        <select class="form-select" id="max-tokens-field-name">
                                            <option value="" data-t-option="default_max_tokens">默认 (max_tokens)</option>
                                            <option value="max_completion_tokens" data-t-option="max_completion_tokens_option">max_completion_tokens</option>
                                            <option value="max_output_tokens" data-t-option="max_output_tokens_option">max_output_tokens</option>
                                        </select>
                                        <small class="form-text text-muted" data-t="max_tokens_field_description">指定在 Anthropic → OpenAI 转换时使用的 max_tokens 参数名</small>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info p-2 mt-3">
                                    <small class="text-muted">
                                        <strong data-t="description">说明：</strong><br>
                                        <span data-t="max_tokens_default_description">• 默认：使用 max_tokens 字段名，保持兼容性</span><br>
                                        <span data-t="max_completion_tokens_description">• max_completion_tokens：OpenAI 新推荐的字段名</span><br>
                                        <span data-t="max_output_tokens_description">• max_output_tokens：某些端点支持的字段名</span>
                                    </small>
                                </div>
                            </div>

                            <!-- 官方帐号增强保护配置区域 -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-shield-alt"></i> <span data-t="enhanced_protection_configuration">官方帐号增强保护</span>
                                    </h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enhanced-protection-enabled">
                                        <label class="form-check-label" for="enhanced-protection-enabled" data-t="enable_enhanced_protection">启用增强保护</label>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning p-2 mt-3">
                                    <small class="text-muted">
                                        <strong data-t="description">说明：</strong><br>
                                        <span data-t="enhanced_protection_anthropic_only">• 仅适用于 api.anthropic.com 官方端点</span><br>
                                        <span data-t="enhanced_protection_allowed_warning_trigger">• 启用后当 Rate Limit 状态变为 allowed_warning 时立即禁用端点</span><br>
                                        <span data-t="enhanced_protection_disable_after_failure">• 禁用时仅在彻底失败后才禁用端点</span><br>
                                        <span data-t="enhanced_protection_account_protection">• 可有效保护官方帐号避免被限流</span>
                                    </small>
                                </div>
                            </div>


                        </div>

                        <!-- Advanced Configuration 2 Tab -->
                        <div class="tab-pane fade" id="advanced2-tab-pane" role="tabpanel" aria-labelledby="advanced2-tab">
                            <!-- HTTP Header 覆盖配置区域 -->
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-code"></i> <span data-t="header_override_configuration">Header 覆盖配置</span>
                                    </h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="header-override-enabled">
                                        <label class="form-check-label" for="header-override-enabled" data-t="enable_header_override">启用 Header 覆盖</label>
                                    </div>
                                </div>
                                
                                <div id="header-override-config" class="d-none-custom">
                                    <small class="form-text text-muted mb-3 d-block" data-t="configure_header_overrides_description">配置在请求发出前要覆盖或删除的HTTP头部</small>
                                    
                                    <div id="header-override-rules-list">
                                        <!-- 动态生成的header覆盖规则列表 -->
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-3" data-action="add-header-override-rule">
                                        <i class="fas fa-plus"></i> <span data-t="add_header_rule">添加Header规则</span>
                                    </button>
                                    
                                    <div class="alert alert-info p-2">
                                        <small class="text-muted">
                                            <strong data-t="description">说明：</strong><br>
                                            <span data-t="header_override_replace_description">• 设置值将替换或添加对应的HTTP头部</span><br>
                                            <span data-t="header_override_delete_description">• 留空值将删除对应的HTTP头部</span><br>
                                            <span data-t="header_override_timing_description">• Header覆盖在认证头部设置后进行，优先级最高</span><br>
                                            <span data-t="header_override_case_insensitive">• Header名称不区分大小写</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Request Parameter 覆盖配置区域 -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-edit"></i> <span data-t="parameter_override_configuration">参数覆盖配置</span>
                                    </h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="parameter-override-enabled">
                                        <label class="form-check-label" for="parameter-override-enabled" data-t="enable_parameter_override">启用 Parameter 覆盖</label>
                                    </div>
                                </div>
                                
                                <div id="parameter-override-config" class="d-none-custom">
                                    <small class="form-text text-muted mb-3 d-block" data-t="configure_parameter_overrides_description">配置在请求发出前要覆盖或删除的请求参数</small>
                                    
                                    <div id="parameter-override-rules-list">
                                        <!-- 动态生成的parameter覆盖规则列表 -->
                                    </div>
                                    
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-3" data-action="add-parameter-override-rule">
                                        <i class="fas fa-plus"></i> <span data-t="add_parameter_rule">添加Parameter规则</span>
                                    </button>
                                    
                                    <div class="alert alert-info p-2">
                                        <small class="text-muted">
                                            <strong data-t="description">说明：</strong><br>
                                            <span data-t="parameter_override_replace_description">• 设置值将替换或添加对应的请求参数</span><br>
                                            <span data-t="parameter_override_delete_description">• 留空值将删除对应的请求参数</span><br>
                                            <span data-t="parameter_override_timing_description">• Parameter覆盖在模型重写后、格式转换前进行</span><br>
                                            <span data-t="parameter_override_examples">• 常用参数: max_tokens, temperature, top_p</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-t="cancel">取消</button>
                <button type="button" class="btn btn-primary" data-action="save-endpoint" data-t="save">保存</button>
            </div>
        </div>
    </div>
</div>